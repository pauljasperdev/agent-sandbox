# Lima instance for an isolated agent sandbox (Apple Silicon)
# Usage:
#   limactl start --name agent-sandbox ./lima.yaml
#   limactl shell agent-sandbox
#   limactl stop agent-sandbox
#   limactl delete agent-sandbox

minimumLimaVersion: 1.1.0

vmType: vz
arch: aarch64

# Set consistent VM username.
user:
  name: lima
  home: /home/lima

cpus: 4
memory: "16GiB"
disk: "40GiB"

# Use Ubuntu 24.04 cloud image via Lima templates.
base:
  - template:_images/ubuntu-24.04

# No host filesystem exposure (explicitly disable mounts)
mounts: []

# No container runtime.
containerd:
  system: false
  user: false

# Don’t inherit host DNS/VPN; use public DNS.
hostResolver:
  enabled: false
dns:
  - 1.1.1.1
  - 8.8.8.8

# Don’t leak host proxy env into guest.
propagateProxyEnv: false

# Don’t pull host SSH keys/agent into guest.
ssh:
  forwardAgent: false
  loadDotSSHPubKeys: false

# Keep port forwarding “off” (SSH port 22 is still used internally).
portForwards:
  - guestPortRange: [1, 21]
    ignore: true
  - guestPortRange: [23, 65535]
    ignore: true

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -euxo pipefail
      export DEBIAN_FRONTEND=noninteractive

      # Minimal bootstrap prerequisites.
      # Everything else is installed via dotfiles bootstrap.
      apt-get update
      apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        git \
        rsync \
        sudo

      # Ensure provisioning never hangs on sudo prompts.
      install -m 0440 /dev/stdin /etc/sudoers.d/99-lima-nopasswd <<'EOF'
      lima ALL=(ALL) NOPASSWD:ALL
      EOF

      # Ensure docker group exists and lima can access the daemon before login.
      groupadd -f docker
      usermod -aG docker lima

      # Refresh docker group membership for first login shells.
      install -m 0644 /dev/stdin /etc/profile.d/docker-group.sh <<'EOF'
      if [ -n "${PS1-}" ] && [ -z "${DOCKER_GROUP_REFRESHED-}" ]; then
        if command -v id >/dev/null 2>&1 && command -v getent >/dev/null 2>&1; then
          if ! id -nG | tr ' ' '\n' | grep -qx docker; then
            if getent group docker | grep -qw "${USER}"; then
              export DOCKER_GROUP_REFRESHED=1
              exec newgrp docker
            fi
          fi
        fi
      fi
      EOF

      # Ensure zsh login shells source /etc/profile.d scripts.
      if [ ! -f /etc/zprofile ]; then
        install -m 0644 /dev/stdin /etc/zprofile <<'EOF'
      if [ -f /etc/profile ]; then
        . /etc/profile
      fi
      EOF
      fi

  - mode: user
    script: |
      #!/bin/bash
      set -euxo pipefail

      dotfiles_repo="https://github.com/pauljasperdev/dotfiles"
      dotfiles_dir="${HOME}/.dotfiles"

      if [ ! -d "${dotfiles_dir}/.git" ]; then
        git clone "${dotfiles_repo}" "${dotfiles_dir}"
      fi

      # Converts the clone to git-dir-only style (per dotfiles AGENTS.md).
      "${dotfiles_dir}/.bootstrap.move.sh"

      # Installs apt prereqs + Homebrew bundle deps.
      # Ensure fully non-interactive install.
      NONINTERACTIVE=1 "${HOME}/.bootstrap.debian.sh"

      # Ensure docker group exists and lima can access the daemon.
      sudo groupadd -f docker
      sudo usermod -aG docker "${USER}"

      # Ensure an 8GiB swapfile is configured.
      swapfile="/swapfile"
      if ! sudo swapon --show | awk '{print $1}' | grep -qx "${swapfile}"; then
        if [ ! -f "${swapfile}" ]; then
          sudo fallocate -l 8G "${swapfile}"
          sudo chmod 600 "${swapfile}"
          sudo mkswap "${swapfile}"
        fi
        sudo swapon "${swapfile}"
      fi
      if ! grep -qxF "${swapfile} none swap sw 0 0" /etc/fstab; then
        echo "${swapfile} none swap sw 0 0" | sudo tee -a /etc/fstab >/dev/null
      fi

      # Ensure Homebrew binaries are on PATH for login shells.
      brew_prefix="/home/linuxbrew/.linuxbrew"
      if [ -x "${brew_prefix}/bin/brew" ]; then
        install -m 0644 /dev/stdin /tmp/homebrew-path.sh <<'EOF'
      export PATH="/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:${PATH}"
      EOF
        sudo mv /tmp/homebrew-path.sh /etc/profile.d/homebrew-path.sh
        sudo chmod 0644 /etc/profile.d/homebrew-path.sh
      fi

      # Make Homebrew zsh the default login shell (so `limactl shell` lands in zsh).
      brew_zsh="/home/linuxbrew/.linuxbrew/bin/zsh"
      if [ -x "${brew_zsh}" ]; then
        if ! grep -qxF "${brew_zsh}" /etc/shells; then
          printf '%s\n' "${brew_zsh}" | sudo tee -a /etc/shells >/dev/null
        fi
        sudo usermod --shell "${brew_zsh}" "${USER}" || true
      fi
