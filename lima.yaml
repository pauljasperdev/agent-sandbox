# Lima instance for an isolated agent sandbox (Apple Silicon)
# Usage:
#   limactl start --name agent-sandbox ./lima.yaml
#   limactl shell agent-sandbox
#   limactl stop agent-sandbox
#   limactl delete agent-sandbox

minimumLimaVersion: 1.1.0

vmType: vz
arch: aarch64

# Set consistent VM username.
user:
  name: lima
  home: /home/lima

cpus: 4
memory: "8GiB"
disk: "40GiB"

# Use Ubuntu 24.04 cloud image via Lima templates.
base:
  - template:_images/ubuntu-24.04

# No host filesystem exposure (explicitly disable mounts)
mounts: []

# No container runtime.
containerd:
  system: false
  user: false

# Don’t inherit host DNS/VPN; use public DNS.
hostResolver:
  enabled: false
dns:
  - 1.1.1.1
  - 8.8.8.8

# Don’t leak host proxy env into guest.
propagateProxyEnv: false

# Don’t pull host SSH keys/agent into guest.
ssh:
  forwardAgent: false
  loadDotSSHPubKeys: false

# Keep port forwarding “off” (SSH port 22 is still used internally).
portForwards:
  - guestPortRange: [1, 21]
    ignore: true
  - guestPortRange: [23, 65535]
    ignore: true

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -euxo pipefail
      export DEBIAN_FRONTEND=noninteractive

      # Minimal bootstrap prerequisites.
      # Everything else is installed via dotfiles bootstrap.
      apt-get update
      apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        git \
        rsync \
        sudo

      # Ensure provisioning never hangs on sudo prompts.
      install -m 0440 /dev/stdin /etc/sudoers.d/99-lima-nopasswd <<'EOF'
      lima ALL=(ALL) NOPASSWD:ALL
      EOF

  - mode: user
    script: |
      #!/bin/bash
      set -euxo pipefail

      dotfiles_repo="https://github.com/pauljasperdev/dotfiles"
      dotfiles_dir="${HOME}/.dotfiles"

      if [ ! -d "${dotfiles_dir}/.git" ]; then
        git clone "${dotfiles_repo}" "${dotfiles_dir}"
      fi

      # Converts the clone to git-dir-only style (per dotfiles AGENTS.md).
      "${dotfiles_dir}/.bootstrap.move.sh"

      # Installs apt prereqs + Homebrew bundle deps.
      # Ensure fully non-interactive install.
      NONINTERACTIVE=1 "${HOME}/.bootstrap.debian.sh"

      # Make Homebrew zsh the default login shell (so `limactl shell` lands in zsh).
      brew_zsh="/home/linuxbrew/.linuxbrew/bin/zsh"
      if [ -x "${brew_zsh}" ]; then
        if ! grep -qxF "${brew_zsh}" /etc/shells; then
          printf '%s\n' "${brew_zsh}" | sudo tee -a /etc/shells >/dev/null
        fi
        sudo usermod --shell "${brew_zsh}" "${USER}" || true
      fi
